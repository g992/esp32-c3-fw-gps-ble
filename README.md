# ublox-gps-ble

Минимальная прошивка для ESP32-C3, которая читает навигационные сообщения NMEA по UART и рассылает текущие координаты через BLE.

## Подключение
- Питание GPS-модуля обычно заводят на 3V3 и GND ESP32-C3, а линию EN выводят на пин `GPS_EN` (GPIO7).
- Связь UART чаще всего организуют как `GPS_TX` → GPIO3 (RX контроллера) и `GPS_RX` → GPIO4 (TX контроллера) со скоростью 115200 бод.
- Сигнал PPS принято подавать на GPIO6 (`GPS_PPS`); светодиод статуса использует GPIO8 с активным уровнем LOW.

## BLE протокол
- Сервис `14f0514a-e15f-4ad3-89a6-b4cb3ac86abe` содержит характеристики для навигации и управления устройством.
- `12c64fea-7ed9-40be-9c7e-9912a5050d23` передает JSON `{"lt":<широта>,"lg":<долгота>,"hd":<курс>,"spd":<скорость>,"alt":<высота>}`.
- `3e4f5d6c-7b8a-9d0e-1f2a-3b4c5d6e7f8a` отправляет JSON `{"fix":<0|1>,"hdop":<значение>,"signals":[...],"ttff":<секунды>}`.
- `a37f8c1b-281d-4e15-8fb2-0b7e6ebd21c0` управляет режимом точки доступа Wi-Fi (`'1'` — запустить AP, `'0'` — состояние только для чтения).
- `d047f6b3-5f7c-4e5b-9c21-4c0f2b6a8f10` переключает режим работы: `'0'` — стандартная навигация, `'1'` — RAW UART passthrough (чтение/запись). В passthrough режиме навигационные характеристики не обновляются.
- `f3a1a816-28f2-4b6d-9f76-6f7aa2d06123` задает скорость UART GPS (ASCII значение от 4800 до 921600 бод).
- `1fd95e59-993e-4bf5-a0b7-f481508c9a94` управляет профилем GNSS конфигурации UBX (`'0'` — Full systems, `'1'` — GLONASS+BeiDou+Galileo, `'2'` — только GLONASS, `'3'` — пользовательский). Запись перезапускает UBX-скрипт и сохраняет выбор во flash; при custom используется сохраненный кадр или выполняется Full systems при его отсутствии.
- `7f0c9ad9-c6e8-4d2a-b3c1-1703708c6c2d` выбирает профиль базовых настроек (`'0'` — стандартные кадры RAM+BBR, `'1'` — пользовательский кадр только в RAM).
- `0abf4f57-12a2-47d9-9c61-96e0d47f332b` принимает пользовательский UBX кадр для GNSS профиля (ASCII hex с sync/LEN/CK), сохраняет его в NVS и отправляет при профиле `Custom`.
- `4b88f5a8-3b35-4c64-a241-0c7fdfced0e0` принимает пользовательский UBX кадр базовых настроек; хранится в NVS и отправляется только в RAM при выбранном кастомном профиле настроек.

## Настройка модема по UBX
- При старте контроллер переводит UART в режим без парсера и выполняет конвейер: отключить NMEA → проверить связь через UBX-MON-VER → применить базовые настройки (стандартные RAM+BBR или пользовательский кадр только в RAM) → применить выбранный профиль GNSS (включая пользовательский кадр при наличии) → запросить значения через CFG-VALGET для проверки → включить NMEA и запустить парсер.
- Команды описаны в `src/ubx_command_set.cpp`: `kUbxDisableNmeaSequence`, последовательности настроек (дефолтная или кастомная), профильные последовательности (`Full systems`, `GLONASS+BeiDou+Galileo`, `GLONASS only`, `Custom`) и `kUbxEnableNmeaSequence`. При необходимости добавляйте свои пакеты (включая sync/CK) или правьте значения ключей `UbxKeyValue`.
- Проверка CFG-VALGET выполняется для всех ключей активного профиля; несоответствие или таймаут переводят индикатор в состояние `STATUS_NO_MODEM`.
- Профили и кадры берутся по BLE или из NVS (`profile`, `cfgsel`, пользовательские кадры). Значение `'0'` (Full systems / дефолтные настройки) применяется по умолчанию; пользовательские кадры сохраняются в NVS и переиспользуются после перезагрузки.

## OTA инструменты
- OTA включается записью `'1'` в характеристику `0f6f8ff7-1b61-4d44-9f31-3536c3a601a7`; `'0'` закрывает возможность и выключает временный OTA-сервер. Актуальные UUID описаны в `BLE_PROTOCOL.md`.
- После разрешения открывается страница ElegantOTA на `http://<ip>/update`. Если нет Wi‑Fi и AP, прошивка запросит включение точки доступа; возможность ОТА обновления авто-закрывается через ~10 минут, при разрыве BLE или сразу после успешной загрузки.
